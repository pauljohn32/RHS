
  ___  ____  ____  ____  ____ (R)
 /__    /   ____/   /   ____/
___/   /   /___/   /   /___/   14.2   Copyright 1985-2015 StataCorp LP
  Statistics/Data Analysis            StataCorp
                                      4905 Lakeway Drive
     Special Edition                  College Station, Texas 77845 USA
                                      800-STATA-PC        http://www.stata.com
                                      979-696-4600        stata@stata.com
                                      979-696-4601 (fax)

2-user Stata network perpetual license:
       Serial number:  401406206437
         Licensed to:  CRMDA
                       CRMDA

Notes:
      1.  Stata is running in batch mode.
      2.  Unicode is supported; see help unicode_advice.
      3.  Maximum number of variables is set to 5000; see help set_maxvar.

. do "Ex-4.1.do" 

. * Paul E. Johnson
. * 20160216
. 
. capture log close

. set more off

. log using Ex-4.1.log, replace text
-------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /home/pauljohn/GIT/RHS/exercises/Ex-04.1-gcse/Ex-4.1.log
  log type:  text
 opened on:  13 Mar 2018, 15:35:35

. 
. * London inner schools data
. * use http://www.stata-press.com/data/mlmus3/gcse, clear
. * saveold gcse.dta12, version(12)
. 
. use gcse.dta12

. 
. sum

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
      school |      4,059    31.00665    18.93914          1         65
     student |      4,059    38.69993    30.26442          1        198
        gcse |      4,059   -.0011786    9.989402    -36.661     36.661
         lrt |      4,059    .0180982     9.93223     -29.35      30.16
        girl |      4,059    .6001478    .4899281          0          1
-------------+---------------------------------------------------------
     schgend |      4,059    1.804878    .9141923          1          3
      avslrt |      4,059    .0181069    3.148704    -7.5596     6.3766
       schav |      4,059    2.127125    .6530068          1          3
      vrband |      4,059    1.843065    .6308623          1          3

. 
. * RHS p. 212
. * schgend 1: mixed school 2: boys 3: girls
. 
. * Everything is better with labels
. label define schtype 1 "mixed" 2 "boys only" 3 "girls only", replace

. label values schgend schtype

. tab schgend

    schgend |      Freq.     Percent        Cum.
------------+-----------------------------------
      mixed |      2,169       53.44       53.44
  boys only |        513       12.64       66.08
 girls only |      1,377       33.92      100.00
------------+-----------------------------------
      Total |      4,059      100.00

. 
. 
. * From RHS p. 212
. mixed gcse i.schgend##c.lrt || school: lrt, covariance(unstructured) mle

Performing EM optimization: 

Performing gradient-based optimization: 

Iteration 0:   log likelihood = -13998.825  
Iteration 1:   log likelihood = -13998.825  

Computing standard errors:

Mixed-effects ML regression                     Number of obs     =      4,059
Group variable: school                          Number of groups  =         65

                                                Obs per group:
                                                              min =          2
                                                              avg =       62.4
                                                              max =        198

                                                Wald chi2(5)      =     803.89
Log likelihood = -13998.825                     Prob > chi2       =     0.0000

------------------------------------------------------------------------------
        gcse |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     schgend |
  boys only  |   .8546715   1.085021     0.79   0.431    -1.271931    2.981274
 girls only  |    2.43341   .8433413     2.89   0.004     .7804919    4.086329
             |
         lrt |   .5712361   .0271256    21.06   0.000     .5180708    .6244014
             |
     schgend#|
       c.lrt |
  boys only  |  -.0230098   .0573895    -0.40   0.688    -.1354911    .0894716
 girls only  |   -.029544   .0447032    -0.66   0.509    -.1171606    .0580726
             |
       _cons |  -.9976073    .506809    -1.97   0.049    -1.990935   -.0042799
------------------------------------------------------------------------------

------------------------------------------------------------------------------
  Random-effects Parameters  |   Estimate   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
school: Unstructured         |
                    var(lrt) |   .0143797   .0045359      .0077491     .026684
                  var(_cons) |   7.828436   1.615416      5.224294    11.73066
              cov(lrt,_cons) |   .2002265   .0663294      .0702232    .3302298
-----------------------------+------------------------------------------------
               var(Residual) |   55.38086   1.249724      52.98482    57.88524
------------------------------------------------------------------------------
LR test vs. linear model: chi2(3) = 381.45                Prob > chi2 = 0.0000

Note: LR test is conservative and provided only for reference.

. 
. * I noticed mixed has different output format than xtmixed
. * Also prevent printing of ridiculous se on random effects
. mixed gcse i.schgend##c.lrt || school: lrt, /// 
>    covariance(unstructured) mle stddev nostderr

Performing EM optimization: 

Performing gradient-based optimization: 

Iteration 0:   log likelihood = -13998.825  
Iteration 1:   log likelihood = -13998.825  

Mixed-effects ML regression                     Number of obs     =      4,059
Group variable: school                          Number of groups  =         65

                                                Obs per group:
                                                              min =          2
                                                              avg =       62.4
                                                              max =        198

                                                Wald chi2(5)      =     803.89
Log likelihood = -13998.825                     Prob > chi2       =     0.0000

------------------------------------------------------------------------------
        gcse |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     schgend |
  boys only  |   .8546715   1.085021     0.79   0.431    -1.271931    2.981274
 girls only  |    2.43341   .8433413     2.89   0.004     .7804919    4.086329
             |
         lrt |   .5712361   .0271256    21.06   0.000     .5180708    .6244014
             |
     schgend#|
       c.lrt |
  boys only  |  -.0230098   .0573895    -0.40   0.688    -.1354911    .0894716
 girls only  |   -.029544   .0447032    -0.66   0.509    -.1171606    .0580726
             |
       _cons |  -.9976073    .506809    -1.97   0.049    -1.990935   -.0042799
------------------------------------------------------------------------------

------------------------------------------------------------------------------
  Random-effects Parameters  |   Estimate   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
school: Unstructured         |
                     sd(lrt) |   .1199154          .             .           .
                   sd(_cons) |   2.797934          .             .           .
             corr(lrt,_cons) |   .5967727          .             .           .
-----------------------------+------------------------------------------------
                sd(Residual) |   7.441831          .             .           .
------------------------------------------------------------------------------
LR test vs. linear model: chi2(3) = 381.45                Prob > chi2 = 0.0000

Note: LR test is conservative and provided only for reference.

. 
. 
. 
. * Make some plots. 
. 
. egen pickone = tag(school)

. 
. twoway (scatter gcse lrt), by(schgend)

. 
. twoway (scatter gcse lrt) , by(schgend, compact legend(off))

. gsort +school +lrt

. predict gcsefit, fitted

. * Note difference from "fitted" and "xb" there.  "fitted" includes
. * random effects
. 
. * Trellis plot
. twoway (scatter gcse lrt, msymbol(smcircle_hollow) mlwidth(vvthin)) ///
>     (line gcsefit lrt, connect(ascending)), ///
>     by(school, compact legend(off)) ///
>     xtitle(LRT) ytitle (GCSE) legend(order(1 "observed" 2 "predicted"))

. 
. * omit the by for spaghetti
. twoway (scatter gcse lrt)(line gcsefit lrt, connect(ascending)), ///
>                 xtitle(LRT) ytitle (GCSE) legend(order(1 "observed" 2 "predic
> ted"))

. 
. 
. twoway (scatter gcse lrt, msize(small) msymbol(smcircle_hollow) mlwidth(vvthi
> n)) ///
>     (line gcsefit lrt, connect(ascending)), ///
>     xtitle(LRT) ytitle (GCSE) legend(order(1 "observed" 2 "predicted"))

. * I'm sorry to say that Stata makes this so tedious to color code the 
. * dots with the school type that I'm stopping in anger.
. 
. 
. 
. * Goal: create a trellis plot for a subset of the groups
. * This is the method in RHS p. 237. Creates a marker variable for the group
. * then assigns random numbers to groups, then sorts, then creates numerical
. * rank. 
. * create 1 in first row for each school
. * egen pickone = tag(school) 
. set seed 234234

. gen r = uniform() if pickone == 1
(3,994 missing values generated)

. egen num = rank(r) if r < . 
(3994 missing values generated)

. egen number = mean(num), by(school)

. 
. * Here's a partial fail
. twoway (scatter gcse lrt if number<=6, msymbol(smcircle_hollow) mlwidth(vvthi
> n)) ///
>     (line gcsefit lrt, connect(ascending)), ///
>     by(school, compact legend(off)) ///
>     xtitle(LRT) ytitle (GCSE) legend(order(1 "observed" 2 "predicted"))

. * Still a fail:
. twoway (scatter gcse lrt if number<=6, msymbol(smcircle_hollow) mlwidth(vvthi
> n)) ///
>     (line gcsefit lrt if number<=6, connect(ascending)), ///
>     by(school, compact legend(off)) ///
>     xtitle(LRT) ytitle (GCSE) legend(order(1 "observed" 2 "predicted"))

.     
. * keep if number <= 6
. * twoway (scatter gcse lrt, msymbol(smcircle_hollow) mlwidth(vvthin)) ///
> *    (line gcsefit lrt, connect(ascending)), ///
> *    by(school, compact legend(off)) ///
> *    xtitle(LRT) ytitle (GCSE) legend(order(1 "observed" 2 "predicted"))
. * Oops. destroyed data. How to avoid?
. * run this as a block
. preserve

. keep if number <= 6
(3,654 observations deleted)

. twoway (scatter gcse lrt, msymbol(smcircle_hollow) mlwidth(vvthin)) ///
>     (line gcsefit lrt, connect(ascending)), ///
>     by(school, compact legend(off)) ///
>     xtitle(LRT) ytitle (GCSE) legend(order(1 "observed" 2 "predicted"))

.  
. preserve
already preserved
r(621);

end of do-file
r(621);
