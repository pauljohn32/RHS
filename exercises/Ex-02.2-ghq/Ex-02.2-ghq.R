## ----import--------------------------------------------------------------
if (!file.exists("ghq.csv")){
    ghq <- data.frame(
        id = seq(1, 12, by =1),
        g = c(12, 8, 22, 10, 10, 6, 8, 4, 14, 6, 2, 22, 12, 7, 24, 14, 8, 4, 5, 6, 14, 5, 5, 16),
        occasion = rep(c(1,2), each = 12)
    )
    write.csv(ghq, "ghq.csv", row.names = FALSE)
} else {
    ghq <- read.csv("ghq.csv")
}

## ----recode10------------------------------------------------------------
rockchalk::summarize(ghq)
ghq$id.orig <- ghq$id
ghq$id <- as.factor(ghq$id)

## ----recode20------------------------------------------------------------
ghq

## ----lmer10--------------------------------------------------------------
library(lme4)
m1 <- lmer(g ~ (1|id), data = ghq, REML = TRUE)
summary(m1)

## ----confint-------------------------------------------------------------
confint(m1, method = "profile")

## ----blups10-------------------------------------------------------------
m1.ranef <- ranef(m1, condVar = TRUE)
m1.ranef

## ----dotplot10-----------------------------------------------------------
library(lattice)
dotplot(m1.ranef)

## ------------------------------------------------------------------------
m1.ranef.byid <- m1.ranef[["id"]][ , "(Intercept)"]
m1.ranef.byid

## ------------------------------------------------------------------------
lm0 <- lm(g ~ 1, data = ghq)
overallavg <- unname(coef(lm0)[1])
overallavg

## ------------------------------------------------------------------------
lm1 <- lm(g ~ 0 + id, data = ghq)
groupavg <- coef(lm1)
groupavg

## ------------------------------------------------------------------------
aggregate(ghq$g, list(id = ghq$id), mean, na.rm = TRUE)

## ------------------------------------------------------------------------
lambda <- 5.92^2 / (5.92^2 + (1.915^2)/rep(2, 12))
lambda

## ------------------------------------------------------------------------
eb.blups <- lambda * groupavg + (1 - lambda) * overallavg
eb.blups

## ------------------------------------------------------------------------
coef(m1)

## ------------------------------------------------------------------------
overallavg + m1.ranef.byid

## ------------------------------------------------------------------------
m1.resid.sd <- attr(VarCorr(m1), "sc")
m1.resid.sd
## Again, not easy. That is tucked away as an attribute of VarCorr output

## ------------------------------------------------------------------------
m1.id.sd <- attr(VarCorr(m1)[["id"]], "stddev")
m1.id.sd

## ------------------------------------------------------------------------
npergroup <- aggregate(ghq$id, list(id = ghq$id), length)

## ------------------------------------------------------------------------
## shrinkage <- psi_hat/(psi_hat + (theta_hat/12))
lambda2 <- m1.id.sd^2 / (m1.id.sd^2 + (m1.resid.sd^2 / npergroup$x))
lambda2

## ------------------------------------------------------------------------
lambda

## ------------------------------------------------------------------------
lambda2 - lambda

## ------------------------------------------------------------------------
m2 <- lmer(g ~ factor(occasion)  + (1|id), data = ghq)
summary(m2)

